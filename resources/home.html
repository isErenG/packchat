<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>packchat</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
            integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
            crossorigin="anonymous"
        />
        <style>
            :root {
                color-scheme: dark; /* native dark form controls */
                --bg: #0e0f14; /* dark grey */
                --panel: #131826; /* card/panel */
                --text: #e6eef5; /* primary text */
                --muted: #9aa4b2; /* placeholders, subtle */
                --border: #1d2330; /* borders */
                --link: #7aa2ff; /* links */
                --link-hover: #a6c1ff;
            }

            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                background: var(--bg);
                color: var(--text);
                font:
                    15px/1.45 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Arial,
                    sans-serif;
            }

            a {
                color: var(--link);
            }
            a:hover {
                color: var(--link-hover);
            }
            hr {
                border-color: var(--border);
            }

            /* Inputs/buttons (override Pure defaults just enough) */
            input,
            textarea,
            select {
                background: #0f1422;
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 0.55rem 0.7rem;
            }
            input::placeholder,
            textarea::placeholder {
                color: var(--muted);
            }

            .pure-form input:not([type]) {
                box-shadow: none;
            }

            .pure-button {
                background: #223155;
                color: #fff;
                border: 1px solid var(--border);
                border-radius: 8px;
            }
            .pure-button:hover,
            .pure-button:focus {
                background: #2b3e6e;
            }

            /* Tables/menus if you use them */
            .pure-table {
                background: var(--panel);
                color: var(--text);
            }
            .pure-table thead {
                background: #0f1422;
            }
            .pure-table td,
            .pure-table th {
                border-color: var(--border);
            }
            .pure-menu {
                background: var(--panel);
            }
            .pure-menu-link {
                color: var(--text);
            }
            .pure-menu-link:hover {
                background: #0f1422;
            }

            /* Optional helpers */
            .wrap {
                max-width: 900px;
                margin: 0 auto;
                padding: 1rem;
            }
            .panel {
                background: var(--panel);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 1rem;
            }
            .chat {
                display: flex;
                justify-content: center;
            }

            .chat form {
                display: flex;
                gap: 0.5rem;
                width: 100%;
                max-width: 520px; /* controls form width */
                margin: 0 auto;
            }
            /* Stack messages above the form, centered */
            .chat {
                display: flex;
                flex-direction: column; /* vertical */
                align-items: center; /* center horizontally */
                gap: 0.75rem;
            }

            /* Make each message size to its content */
            /* Message container */
            #messages {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.25rem 0;
            }

            /* Base bubble styles */
            .msg,
            .msg-right {
                padding: 0.6rem 0.75rem;
                max-width: calc(
                    50% - var(--gutter)
                ); /* â€¦never cross the midpoint */
                border-radius: 16px;
                line-height: 1.4;
                white-space: pre-wrap;
                overflow-wrap: anywhere;
                word-break: normal;
                max-width: 60%; /* bubble width limit */
            }

            /* Left side (other users) */
            .msg {
                background: #151b2a;
                color: var(--text);
                align-self: flex-start; /* anchor left */
                border-top-left-radius: 6px;
            }

            /* Right side (your messages) */
            .msg-right {
                background: #223155;
                color: var(--text);
                align-self: flex-end; /* anchor right */
                border-top-right-radius: 6px;
            }

            /* Make inputs clearly distinct from page bg */
            input,
            textarea,
            select {
                background: #111a2b; /* more contrast than #0e0f14 */
                color: var(--text);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 0.55rem 0.7rem;
            }
        </style>

        <style>
            :root {
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Arial,
                    sans-serif;
            }
            .wrap {
                max-width: 900px;
                margin: 0 auto;
                padding: 1rem;
            }
        </style>
    </head>
    <body>
        <div class="wrap pure-g">
            <div class="pure-u-1-5"></div>

            <div class="pure-u-3-5">
                <h1>packchat</h1>
                <br />
                <div class="chat pure-u-1">
                    <div id="messages"></div>

                    <form class="pure-form">
                        <input placeholder="Enter message..." />
                        <button class="pure-button">Send</button>
                    </form>
                </div>
            </div>

            <div class="pure-u-1-5"></div>
        </div>
    </body>

    <script
        src="https://cdn.jsdelivr.net/gh/ygoe/msgpack.js/msgpack.min.js"
        defer
    ></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            const session_id = Math.random().toString(36).substring(2, 15);
            console.log(session_id);
            const WS_URL = location.origin.replace(/^http/, "ws") + "/ws";
            const ws = new WebSocket(WS_URL);
            ws.binaryType = "arraybuffer";

            const messages = document.getElementById("messages");
            const form = document.querySelector(".chat form");
            const input = form.querySelector("input");

            ws.onmessage = (ev) => {
                try {
                    const m = window.msgpack.deserialize(
                        new Uint8Array(ev.data),
                    ); // {A,B,C}
                    const text = esc(m.B || "");

                    if (session_id == m.A) {
                        messages.insertAdjacentHTML(
                            "beforeend",
                            `<div class="msg-right">${text}</div>`,
                        );
                    } else {
                        messages.insertAdjacentHTML(
                            "beforeend",
                            `<div class="msg">${text}</div>`,
                        );
                    }

                    messages.scrollTop = messages.scrollHeight;
                } catch (e) {
                    console.error("Bad MsgPack:", e);
                }
            };

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (!text || ws.readyState !== WebSocket.OPEN) return;
                ws.send(
                    window.msgpack.serialize({
                        A: session_id,
                        B: text,
                        C: Date.now(),
                    }),
                );
                input.value = "";
            });

            function esc(s) {
                return String(s).replace(
                    /[&<>"']/g,
                    (c) =>
                        ({
                            "&": "&amp;",
                            "<": "&lt;",
                            ">": "&gt;",
                            '"': "&quot;",
                            "'": "&#39;",
                        })[c],
                );
            }
        });
    </script>
</html>
